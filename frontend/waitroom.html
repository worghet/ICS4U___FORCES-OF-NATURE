<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FON - Waitroom</title>
</head>
<body>
<h1>
    Welcome to the waitroom!
</h1>
<p>
    Choose a character, see who is here now, and get ready to play!
</p>

<h1>
    PLAYERS ONLINE:
</h1>

<ol id="player-list">

</ol>

<button onclick="backToMain()">
    Go back (leave lobby)
</button>

<button id="anglerButton" onclick="characterSelected(0)">
    Angler
</button>

<button id="golemButton" onclick="characterSelected(1)">
    Golem
</button>

<button id="welderButton" onclick="characterSelected(2)">
    Welder

</button>

<button onclick="startGame()">
    Start game
</button>

<script>

    // variables
    let gameStarted = false;
    const playerList = document.getElementById("player-list");


    const ANGLER_INDEX = 0;
    const GOLEM_INDEX = 1;
    const WELDER_INDEX = 2;

    // actual program:

    function characterSelected(characterIndex) {

        resetButtons();

        if (characterIndex == ANGLER_INDEX) {
            console.log("angler selected");
            document.getElementById("anglerButton").style.backgroundColor = "aqua";
            document.getElementById("anglerButton").disabled = true;
        }
        else if (characterIndex == GOLEM_INDEX) {
            console.log("golem selected");
            document.getElementById("golemButton").style.backgroundColor = "saddlebrown";
            document.getElementById("golemButton").disabled = true;
        }
        // welder selected
        else {
            console.log("welder selected");
            document.getElementById("welderButton").style.backgroundColor = "red";
            document.getElementById("welderButton").disabled = true;
        }

        fetch("/character-select", {

            method: "POST",
            body: JSON.stringify({
                id: sessionStorage.getItem("playerId"),
                character: characterIndex
            })

        });

    }

    function resetButtons() {
        document.getElementById("anglerButton").style.backgroundColor = "grey";
        document.getElementById("golemButton").style.backgroundColor = "grey";
        document.getElementById("welderButton").style.backgroundColor = "grey";

        document.getElementById("anglerButton").disabled = false;
        document.getElementById("golemButton").disabled = false;
        document.getElementById("welderButton").disabled = false;
    }


    const checkInterval = setInterval(() => {
        if (!gameStarted) {
            hasTheGameStarted();

            // manage players in the table
            // refreshOnlinePlayers();

        } else {
            window.location.href = "/forces-of-nature/gameplay";
            console.log("Game started!!");

        }
    }, 1000);




    // functions
    function hasTheGameStarted() {
        // Check for if the game has started yet
        fetch("/start-game", {
            method: "GET"
        })
        .then(response => response.json())
        .then(response => {
            console.log(response);
            if (response.gameActive) {
                // If the game HAS started, set variable to true to stop constantly checking.
                gameStarted = true;
                clearInterval(checkInterval);
                // Start the repeating processes (sending data and updating screen).
                window.location.href = "/forces-of-nature/gameplay";
            }
            else {

                // game hasnt started yet; update the table of players
                updatePlayerList(response.playersOnline);

            }
        });
    }

    function updatePlayerList(players) {
        //        const playerCount = document.getElementById("playerCount");

        // Clear the existing list
        playerList.innerHTML = "";

        // Add each player to the list
        players.forEach(player => {
            const listItem = document.createElement("li");
            listItem.textContent = player.username + " (put selected character here)";
            playerList.appendChild(listItem);
        });

        // playerCount.textContent = players.length;
    }


    function backToMain() {
        window.location.href = "/forces-of-nature";
    }

    function startGame() {

        fetch("/start-game", {

            method: "POST"

        });

        gameStarted = true;
    }

    window.onload = function() {
        // Get THIS player's id
        const playerId = sessionStorage.getItem("playerId");

        if (!playerId) {
            console.log("No Player ID found! Redirecting...");
            window.location.href = "/forces-of-nature"; // Redirect if no ID
        } else {
          console.log("Playing as player with id:", playerId);
        }
    };

    window.addEventListener("beforeunload", (event) => {

        // Directly compare pathname to check if it's the gameplay page
        if (gameStarted) {
            return;
        }

        const playerID = sessionStorage.getItem("playerId");

        if (playerID) {
            fetch("/remove-player", {
                method: "POST",
                body: playerID
            });

            sessionStorage.removeItem("playerId");
        }
    });

</script>

</body>
</html>
